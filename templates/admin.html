{{define "title"}}Admin Panel{{end}}

{{define "content"}}
<div class="admin-page">
    <div class="flash-region">
        {{with .Error}}
        <div class="alert alert-error">{{.}}</div>
        {{end}}
        {{with .Success}}
        <div class="alert alert-success">{{.}}</div>
        {{end}}
    </div>

    <div class="admin-grid">
        <section class="card">
            <div class="card-header">
                <div>
                    <h2>User Groups</h2>
                    <p class="card-subtitle">Organise users into research teams or labs for quick filtering.</p>
                </div>
                <form action="/admin/add-group" method="POST" class="inline-form add-inline">
                    <input type="text" name="name" placeholder="New group name" required>
                    <button type="submit" class="btn btn-primary btn-small">Add</button>
                </form>
            </div>
            <div class="table-scroll">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th class="col-actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{if .Groups}}
                            {{range .Groups}}
                            <tr>
                                <td>{{.Name}}</td>
                                <td class="col-actions">
                                    <form action="/admin/delete-group/{{.ID}}" method="POST" class="inline-form"
                                          onsubmit="return confirm('Remove group {{.Name}}? Users will be unassigned.');">
                                        <button type="submit" class="btn btn-small btn-danger">Remove</button>
                                    </form>
                                </td>
                            </tr>
                            {{end}}
                        {{else}}
                            <tr>
                                <td colspan="2" class="empty-state">No groups yet. Add your first group to get started.</td>
                            </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <div>
                    <h2>Equipment Catalogue</h2>
                    <p class="card-subtitle">Manage bookable equipment and usage reports.</p>
                </div>
                <button onclick="showEquipmentModal()" class="btn btn-primary btn-small">Add Equipment</button>
            </div>
            <div class="table-scroll">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th class="col-actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{if .Equipment}}
                            {{range .Equipment}}
                            <tr>
                                <td>{{.Name}}</td>
                                <td class="col-actions">
                                    <button onclick="showReportModal({{.ID}}, '{{.Name}}')" class="btn btn-small">Usage</button>
                                    <button onclick="confirmDeleteEquipment({{.ID}}, '{{.Name}}')" class="btn btn-small btn-danger">Remove</button>
                                </td>
                            </tr>
                            {{end}}
                        {{else}}
                            <tr>
                                <td colspan="2" class="empty-state">No equipment registered yet.</td>
                            </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <section class="card">
        <div class="card-header column">
            <div>
                <h2>User Management</h2>
                <p class="card-subtitle">Approve access, assign groups, and grant equipment permissions.</p>
            </div>
        </div>
        <div class="table-scroll">
            <table class="data-table users-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Group</th>
                        <th>Status</th>
                        <th>Equipment Access</th>
                        <th class="col-actions">Admin</th>
                    </tr>
                </thead>
                <tbody>
                    {{if .Users}}
                        {{range .Users}}
                        {{$user := .}}
                        <tr data-user-id="{{$user.UserID}}">
                            <td>
                                <div class="user-meta">
                                    <strong>{{$user.Username}}</strong>
                                    {{if $user.GroupName}}<span class="badge">{{$user.GroupName}}</span>{{end}}
                                </div>
                            </td>
                            <td>
                                <select class="group-select" onchange="updateAccess({{$user.UserID}})">
                                    <option value="">No group</option>
                                    {{range $group := $.Groups}}
                                    <option value="{{$group.Name}}" {{if eq $user.GroupName $group.Name}}selected{{end}}>{{$group.Name}}</option>
                                    {{end}}
                                </select>
                            </td>
                            <td>
                                <label class="toggle">
                                    <input type="checkbox" class="approved-toggle"
                                           {{if $user.Approved}}checked{{end}}
                                           onchange="updateAccess({{$user.UserID}})">
                                    <span>{{if $user.Approved}}Approved{{else}}Pending{{end}}</span>
                                </label>
                            </td>
                            <td>
                                <div class="equipment-access">
                                    <select multiple class="equipment-select"
                                            aria-label="Equipment access for {{.Username}}"
                                            onchange="updateAccess({{$user.UserID}})">
                                        {{range $equipment := $.Equipment}}
                                        <option value="{{$equipment.ID}}"
                                                {{range $user.EquipmentAccess}}
                                                    {{if eq .ID $equipment.ID}}selected{{end}}
                                                {{end}}>
                                            {{$equipment.Name}}
                                        </option>
                                        {{end}}
                                    </select>
                                    <small class="hint">Hold Ctrl/âŒ˜ to toggle multiple items</small>
                                </div>
                            </td>
                            <td class="col-actions">
                                <form action="/admin/set-admin" method="POST" class="inline-form">
                                    <input type="hidden" name="user_id" value="{{$user.UserID}}">
                                    {{if not $user.Admin}}
                                        <button type="submit" name="is_admin" value="true"
                                                class="btn btn-small">Make Admin</button>
                                    {{else}}
                                        <button type="submit" name="is_admin" value="false"
                                                class="btn btn-small btn-danger">Remove</button>
                                    {{end}}
                                </form>
                            </td>
                        </tr>
                        {{end}}
                    {{else}}
                        <tr>
                            <td colspan="5" class="empty-state">No users found.</td>
                        </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
    </section>

    <!-- Add Equipment Modal -->
    <div id="equipment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Equipment</h3>
                <span class="close" onclick="closeEquipmentModal()">&times;</span>
            </div>
            <form action="/admin/add-equipment" method="POST">
                <div class="form-group">
                    <label for="equipment_name">Equipment Name</label>
                    <input type="text" id="equipment_name" name="name" placeholder="e.g. Confocal Microscope" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Add Equipment</button>
                    <button type="button" class="btn" onclick="closeEquipmentModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="report-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Download Usage Report</h3>
                <span class="close" onclick="closeReportModal()">&times;</span>
            </div>
            <div class="form-group">
                <label for="start_date">Start Date</label>
                <input type="date" id="start_date" required>
            </div>
            <div class="form-group">
                <label for="end_date">End Date</label>
                <input type="date" id="end_date" required>
            </div>
            <div class="form-actions">
                <button onclick="downloadReport()" class="btn btn-primary">Download</button>
                <button onclick="closeReportModal()" class="btn">Cancel</button>
            </div>
        </div>
    </div>
</div>

<style>
.admin-page {
    padding: 24px;
    max-width: 1280px;
    margin: 0 auto 60px;
    display: flex;
    flex-direction: column;
    gap: 32px;
}

.flash-region .alert {
    margin-bottom: 0;
}

.admin-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 24px;
}

.card {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(17, 24, 39, 0.08);
    border: 1px solid rgba(17, 24, 39, 0.06);
    padding: 0;
}

.card-header {
    padding: 20px 24px;
    border-bottom: 1px solid rgba(17, 24, 39, 0.06);
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 16px;
}

.card-header.column {
    flex-direction: column;
}

.card-header h2 {
    margin: 0;
    font-size: 1.35rem;
    color: #1f2937;
}

.card-subtitle {
    margin: 4px 0 0;
    color: #6b7280;
    font-size: 0.9rem;
}

.add-inline {
    display: flex;
    gap: 12px;
    align-items: center;
}

.add-inline input {
    flex: 1;
    min-width: 160px;
}

.table-scroll {
    overflow-x: auto;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table thead th {
    text-align: left;
    padding: 14px 24px;
    font-size: 0.85rem;
    letter-spacing: 0.02em;
    text-transform: uppercase;
    color: #6b7280;
    border-bottom: 1px solid rgba(17, 24, 39, 0.06);
    background: #f9fafb;
}

.data-table tbody td {
    padding: 16px 24px;
    border-bottom: 1px solid rgba(17, 24, 39, 0.06);
    vertical-align: top;
}

.data-table tbody tr:last-child td {
    border-bottom: none;
}

.col-actions {
    width: 160px;
    text-align: right;
}

.inline-form {
    display: inline-flex;
    gap: 8px;
    align-items: center;
}

.inline-form input[type="text"] {
    min-width: 0;
}

.btn {
    background: #4f46e5;
    color: #fff;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s ease;
    font-size: 0.9rem;
}

.btn:hover {
    background: #4338ca;
}

.btn-small {
    padding: 6px 12px;
    font-size: 0.85rem;
}

.btn-danger {
    background: #dc2626;
}

.btn-danger:hover {
    background: #b91c1c;
}

.btn-primary {
    background: #2563eb;
}

.btn-primary:hover {
    background: #1d4ed8;
}

.toggle {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    color: #374151;
}

.toggle input[type="checkbox"] {
    width: 18px;
    height: 18px;
}

.group-select,
.equipment-select,
input[type="text"],
input[type="date"],
textarea,
select {
    border: 1px solid rgba(17, 24, 39, 0.12);
    border-radius: 6px;
    padding: 8px 10px;
    font-size: 0.9rem;
    width: 100%;
    transition: border 0.2s ease, box-shadow 0.2s ease;
}

.group-select:focus,
.equipment-select:focus,
input:focus,
textarea:focus,
select:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
}

.equipment-access select {
    min-height: 120px;
}

.hint {
    display: inline-block;
    margin-top: 6px;
    color: #9ca3af;
    font-size: 0.75rem;
}

.badge {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    border-radius: 9999px;
    background: rgba(99, 102, 241, 0.1);
    color: #4338ca;
    font-size: 0.75rem;
    margin-left: 6px;
}

.user-meta {
    display: flex;
    align-items: center;
}

.empty-state {
    text-align: center;
    color: #9ca3af;
    font-style: italic;
    padding: 32px 16px;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(17, 24, 39, 0.4);
    z-index: 20;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background: #fff;
    border-radius: 12px;
    padding: 24px;
    width: min(420px, 90%);
    box-shadow: 0 20px 40px rgba(15, 23, 42, 0.25);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.2rem;
    color: #1f2937;
}

.modal .close {
    font-size: 1.5rem;
    cursor: pointer;
    color: #6b7280;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 16px;
}

.form-group label {
    font-weight: 600;
    color: #374151;
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

@media (max-width: 768px) {
    .card-header {
        flex-direction: column;
        align-items: stretch;
    }

    .col-actions {
        width: auto;
        text-align: left;
    }
}
</style>

<script>
function updateAccess(userId) {
    const row = document.querySelector(`tr[data-user-id="${userId}"]`);
    const approvedToggle = row.querySelector('.approved-toggle');
    const equipmentSelect = row.querySelector('.equipment-select');
    const groupSelect = row.querySelector('.group-select');

    const approved = approvedToggle?.checked ?? false;
    const selectedEquipment = Array.from(equipmentSelect?.selectedOptions ?? [])
        .map(option => parseInt(option.value, 10))
        .filter(Number.isInteger);

    const rawGroupValue = groupSelect?.value ?? '';
    const groupValue = rawGroupValue.trim() || null;
    const groupLabel = groupSelect?.selectedOptions?.[0]?.textContent?.trim() ?? '';

    const badge = row.querySelector('.badge');
    if (groupValue) {
        if (badge) {
            badge.textContent = groupLabel;
        } else {
            const newBadge = document.createElement('span');
            newBadge.className = 'badge';
            newBadge.textContent = groupLabel;
            row.querySelector('.user-meta')?.appendChild(newBadge);
        }
    } else if (badge) {
        badge.remove();
    }

    fetch('/admin/update-access', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            user_id: userId,
            approved: approved,
            group_name: groupValue,
            equipment: selectedEquipment
        })
    })
    .then(response => {
        if (!response.ok) throw new Error('Failed to update access');

        const msg = document.createElement('div');
        msg.className = 'alert alert-success';
        msg.textContent = 'User settings updated';

        const flashRegion = document.querySelector('.flash-region');
        if (flashRegion) {
            flashRegion.appendChild(msg);
        }

        setTimeout(() => msg.remove(), 2500);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update access rights. Please refresh and try again.');
    });
}

function showEquipmentModal() {
    document.getElementById('equipment-modal').style.display = 'flex';
}

function closeEquipmentModal() {
    document.getElementById('equipment-modal').style.display = 'none';
    document.querySelector('#equipment-modal form').reset();
}

function confirmDeleteEquipment(equipmentId, equipmentName) {
    if (confirm(`Remove ${equipmentName}? This will also clear related bookings and permissions.`)) {
        fetch(`/admin/delete-equipment/${equipmentId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to delete equipment');
            }
            location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete equipment');
        });
    }
}

let currentEquipmentId = null;

function showReportModal(equipmentId) {
    currentEquipmentId = equipmentId;
    document.getElementById('report-modal').style.display = 'flex';
}

function closeReportModal() {
    document.getElementById('report-modal').style.display = 'none';
    currentEquipmentId = null;
}

function downloadReport() {
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;

    if (!startDate || !endDate) {
        alert('Please select both start and end dates');
        return;
    }

    window.location.href = `/admin/equipment-report?id=${currentEquipmentId}&start=${startDate}&end=${endDate}`;
    closeReportModal();
}

window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
}
</script>
{{end}}
