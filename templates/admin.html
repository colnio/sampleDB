{{define "title"}}Admin Panel{{end}}

{{define "content"}}
<div class="admin-page">
    <header class="page-heading">
        <h1 class="heading-with-icon">
            <svg class="heading-with-icon__icon" width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                <path d="M12 3l7 3v6c0 4.23-2.86 8.09-7 9-4.14-.91-7-4.77-7-9V6z" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"></path>
                <path d="M12 10.5a3.25 3.25 0 110 6.5 3.25 3.25 0 010-6.5z" fill="none" stroke="currentColor" stroke-width="1.5"></path>
                <circle cx="12" cy="13" r="1.4" fill="currentColor"></circle>
            </svg>
            <span>Admin Panel</span>
        </h1>
    </header>
    <div class="flash-region">
        {{with .Error}}
        <div class="alert alert-error">{{.}}</div>
        {{end}}
        {{with .Success}}
        <div class="alert alert-success">{{.}}</div>
        {{end}}
    </div>

    <div class="admin-grid">
        {{template "admin/groups" .}}

        <section class="card admin-section equipment-card">
            <div class="card-header">
                <div>
                    <h2 class="heading-with-icon heading-with-icon--sm">
                        <svg class="heading-with-icon__icon" width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                            <rect x="4.5" y="8" width="15" height="8.5" rx="1.8" ry="1.8" fill="none" stroke="currentColor" stroke-width="1.5"></rect>
                            <path d="M9 8V6.5a1 1 0 011-1h4a1 1 0 011 1V8" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
                            <path d="M8 12h8" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
                        </svg>
                        <span>Equipment Catalogue</span>
                    </h2>
                    <p class="card-subtitle">Manage bookable equipment and usage reports.</p>
                </div>
                <button onclick="showEquipmentModal()" class="button button--primary button--small">Add Equipment</button>
            </div>
            <div class="card-body card-body--flush">
                <div class="table-scroll">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th class="col-actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{if .Equipment}}
                                {{range .Equipment}}
                                <tr>
                                    <td>{{.Name}}</td>
                                    <td class="col-actions">
                                        <button onclick="showReportModal({{.ID}}, '{{.Name}}')" class="button button--secondary button--small">Usage</button>
                                        <button onclick="confirmDeleteEquipment({{.ID}}, '{{.Name}}')" class="button button--destructive button--small">Remove</button>
                                    </td>
                                </tr>
                                {{end}}
                            {{else}}
                                <tr>
                                    <td colspan="2" class="empty-state">No equipment registered yet.</td>
                                </tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    {{template "admin/users" .}}

    <!-- Add Equipment Modal -->
    <div id="equipment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Equipment</h3>
                <span class="close" onclick="closeEquipmentModal()">&times;</span>
            </div>
            <form action="/admin/add-equipment" method="POST" class="stacked-form">
                <div class="form-group">
                    <label for="equipment_name">Equipment Name</label>
                    <input type="text" id="equipment_name" name="name" placeholder="e.g. Confocal Microscope" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="button button--primary">Add Equipment</button>
                    <button type="button" class="button button--secondary" onclick="closeEquipmentModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="report-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Download Usage Report</h3>
                <span class="close" onclick="closeReportModal()">&times;</span>
            </div>
            <form class="stacked-form">
                <div class="form-group">
                    <label for="start_date">Start Date</label>
                    <input type="date" id="start_date" required>
                </div>
                <div class="form-group">
                    <label for="end_date">End Date</label>
                    <input type="date" id="end_date" required>
                </div>
                <div class="form-actions">
                    <button type="button" onclick="downloadReport()" class="button button--primary">Download</button>
                    <button type="button" onclick="closeReportModal()" class="button button--secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.admin-page {
    padding: var(--space-lg);
    max-width: 1280px;
    margin: 0 auto calc(var(--space-2xl) + var(--space-md));
    display: flex;
    flex-direction: column;
    gap: var(--space-xl);
}

.flash-region .alert {
    margin-bottom: 0;
}

.admin-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: var(--space-lg);
}

.card {
    --card-padding: 0;
}

.card-header {
    padding: calc(var(--space-md) + var(--space-xs)) var(--space-lg);
    border-bottom: 1px solid var(--neutral-200);
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-md);
}

.card-header.column {
    flex-direction: column;
}

.card-header h2 {
    margin: 0;
    font-size: var(--font-size-xl);
    color: var(--color-primary);
}

.card-subtitle {
    margin: var(--space-xs) 0 0;
    color: var(--text-muted);
    font-size: var(--font-size-sm);
}

.add-inline {
    display: flex;
    gap: calc(var(--space-sm) + var(--space-xs));
    align-items: center;
    flex-wrap: wrap;
}

.add-inline input {
    flex: 1;
    min-width: 160px;
}

.table-scroll {
    overflow-x: auto;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table thead th {
    text-align: left;
    padding: calc(var(--space-sm) + var(--space-xs)) var(--space-lg);
    font-size: var(--font-size-sm);
    letter-spacing: 0.02em;
    text-transform: uppercase;
    color: var(--text-muted);
    border-bottom: 1px solid var(--neutral-200);
    background: var(--surface-subtle);
}

.data-table tbody td {
    padding: var(--space-md) var(--space-lg);
    border-bottom: 1px solid var(--border-subtle);
    vertical-align: top;
}

.data-table tbody tr:last-child td {
    border-bottom: none;
}

.col-actions {
    width: 160px;
    text-align: right;
}

.inline-form {
    display: inline-flex;
    gap: var(--space-sm);
    align-items: center;
}

.account-actions {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
    align-items: flex-start;
}

.account-actions .inline-form {
    justify-content: flex-end;
}

.remove-user-btn[disabled] {
    opacity: 0.6;
    cursor: not-allowed;
}

.inline-form input[type="text"] {
    min-width: 0;
}

.toggle {
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: var(--font-size-sm);
    color: var(--neutral-700);
}

.toggle input[type="checkbox"] {
    width: 18px;
    height: 18px;
}

.group-select,
.equipment-select,
input[type="text"],
input[type="date"],
textarea,
select {
    border: 1px solid var(--neutral-200);
    border-radius: var(--radius-sm);
    padding: var(--space-sm) calc(var(--space-sm) + var(--space-xs));
    font-size: var(--font-size-sm);
    width: 100%;
    transition: border 0.2s ease, box-shadow 0.2s ease;
}

.group-select:focus,
.equipment-select:focus,
input:focus,
textarea:focus,
select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
}

.equipment-access select {
    min-height: 120px;
}

.hint {
    display: inline-block;
    margin-top: calc(var(--space-sm) - var(--space-xs));
    color: var(--neutral-400);
    font-size: 0.75rem;
}

.badge {
    display: inline-flex;
    align-items: center;
    padding: 2px var(--space-sm);
    border-radius: 9999px;
    background: rgba(37, 99, 235, 0.12);
    color: var(--color-primary-active);
    font-size: 0.75rem;
    margin-left: calc(var(--space-sm) - var(--space-xs));
}

.user-meta {
    display: flex;
    align-items: center;
}

.empty-state {
    text-align: center;
    color: var(--neutral-400);
    font-style: italic;
    padding: var(--space-xl) var(--space-md);
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(17, 24, 39, 0.4);
    z-index: 20;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background: var(--surface-default);
    border-radius: var(--radius-md);
    padding: var(--space-lg);
    width: min(420px, 90%);
    box-shadow: 0 20px 40px rgba(15, 23, 42, 0.25);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
}

.modal-header h3 {
    margin: 0;
    font-size: var(--font-size-xl);
    color: var(--text-strong);
}

.modal .close {
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--neutral-600);
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: calc(var(--space-sm) - var(--space-xs));
    margin-bottom: var(--space-md);
}

.form-group label {
    font-weight: 600;
    color: var(--neutral-700);
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: calc(var(--space-sm) + var(--space-xs));
    flex-wrap: wrap;
    align-items: center;
}

@media (max-width: 768px) {
    .admin-grid {
        grid-template-columns: 1fr;
    }

    .card-header {
        flex-direction: column;
        align-items: stretch;
        gap: var(--space-sm);
    }

    .add-inline {
        flex-direction: column;
        align-items: stretch;
    }

    .add-inline input,
    .add-inline .button {
        width: 100%;
    }

    .col-actions {
        width: auto;
        text-align: left;
    }

    .form-actions {
        justify-content: stretch;
    }

    .form-actions .button {
        width: 100%;
    }

    .account-actions {
        width: 100%;
    }

    .account-actions .inline-form {
        width: 100%;
        justify-content: flex-start;
        flex-direction: column;
        align-items: stretch;
        gap: var(--space-sm);
    }

    .account-actions .inline-form .button,
    .account-actions .button {
        width: 100%;
    }
}
</style>

<script>
function updateAccess(userId) {
    const row = document.querySelector(`.user-card[data-user-id="${userId}"]`);
    if (!row) {
        return;
    }
    const approvedToggle = row.querySelector('.approved-toggle');
    const equipmentSelect = row.querySelector('.equipment-select');
    const groupSelect = row.querySelector('.group-select');

    const approved = approvedToggle?.checked ?? false;
    const selectedEquipment = Array.from(equipmentSelect?.selectedOptions ?? [])
        .map(option => parseInt(option.value, 10))
        .filter(Number.isInteger);

    const rawGroupValue = groupSelect?.value ?? '';
    const groupValue = rawGroupValue.trim() || null;
    const groupLabel = groupSelect?.selectedOptions?.[0]?.textContent?.trim() ?? '';

    const badge = row.querySelector('.badge');
    if (groupValue) {
        if (badge) {
            badge.textContent = groupLabel;
        } else {
            const newBadge = document.createElement('span');
            newBadge.className = 'badge';
            newBadge.textContent = groupLabel;
            row.querySelector('.user-meta')?.appendChild(newBadge);
        }
    } else if (badge) {
        badge.remove();
    }

    fetch('/admin/update-access', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            user_id: userId,
            approved: approved,
            group_name: groupValue,
            equipment: selectedEquipment
        })
    })
    .then(response => {
        if (!response.ok) throw new Error('Failed to update access');

        const flashRegion = document.querySelector('.flash-region');
        if (flashRegion) {
            flashRegion.querySelectorAll('.alert-temp').forEach(el => el.remove());

            const msg = document.createElement('div');
            msg.className = 'alert alert-success alert-temp';
            msg.textContent = 'User settings updated';
            flashRegion.appendChild(msg);

            setTimeout(() => msg.remove(), 2000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update access rights. Please refresh and try again.');
    });
}

function showEquipmentModal() {
    document.getElementById('equipment-modal').style.display = 'flex';
}

function closeEquipmentModal() {
    document.getElementById('equipment-modal').style.display = 'none';
    document.querySelector('#equipment-modal form').reset();
}

function confirmDeleteEquipment(equipmentId, equipmentName) {
    if (confirm(`Remove ${equipmentName}? This will also clear related bookings and permissions.`)) {
        fetch(`/admin/delete-equipment/${equipmentId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to delete equipment');
            }
            location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete equipment');
        });
    }
}

let currentEquipmentId = null;

function resetPassword(userId) {
    const row = document.querySelector(`.user-card[data-user-id="${userId}"]`);
    const username = row?.dataset.username ?? 'this user';

    if (!confirm(`Reset password for ${username}? They will need to change it after signing in.`)) {
        return;
    }

    fetch('/admin/reset-password', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ user_id: userId }),
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => { throw new Error(text || 'Failed to reset password'); });
        }
        return response.json();
    })
    .then(data => {
        const password = data?.password;
        if (!password) {
            throw new Error('Server did not provide a new password');
        }

        const showPrompt = () => {
            window.prompt('Temporary password generated. Copy it now:', password);
        };

        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(password).then(() => {
                alert(`Temporary password for ${username}: ${password}`);
            }).catch(() => {
                showPrompt();
            });
        } else {
            showPrompt();
        }

        const flashRegion = document.querySelector('.flash-region');
        if (flashRegion) {
            flashRegion.querySelectorAll('.alert-temp').forEach(el => el.remove());

            const msg = document.createElement('div');
            msg.className = 'alert alert-success alert-temp';
            msg.textContent = `Temporary password generated for ${username}.`;
            flashRegion.appendChild(msg);

            setTimeout(() => msg.remove(), 6000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert(error.message || 'Failed to reset password. Please try again.');
    });
}

function confirmRemoveUser(userId) {
    const row = document.querySelector(`.user-card[data-user-id="${userId}"]`);
    const username = row?.dataset.username ?? 'this user';

    if (!confirm(`Remove ${username}? They will no longer be able to sign in.`)) {
        return;
    }

    fetch('/admin/delete-user', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ user_id: userId }),
    })
    .then(response => {
        if (!response.ok) {
            if (response.status === 400) {
                return response.text().then(text => { throw new Error(text || 'Invalid request'); });
            }
            if (response.status === 404) {
                throw new Error('User not found or already removed');
            }
            throw new Error('Failed to remove user');
        }
        return response.json().catch(() => ({}));
    })
    .then(() => {
        const flashRegion = document.querySelector('.flash-region');
        if (flashRegion) {
            flashRegion.querySelectorAll('.alert-temp').forEach(el => el.remove());

            const msg = document.createElement('div');
            msg.className = 'alert alert-success alert-temp';
            msg.textContent = 'User removed';
            flashRegion.appendChild(msg);

            setTimeout(() => msg.remove(), 2000);
        }

        row?.remove();
    })
    .catch(error => {
        console.error('Error:', error);
        alert(error.message || 'Failed to remove user. Please refresh and try again.');
    });
}

function showReportModal(equipmentId) {
    currentEquipmentId = equipmentId;
    document.getElementById('report-modal').style.display = 'flex';
}

function closeReportModal() {
    document.getElementById('report-modal').style.display = 'none';
    currentEquipmentId = null;
}

function downloadReport() {
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;

    if (!startDate || !endDate) {
        alert('Please select both start and end dates');
        return;
    }

    window.location.href = `/admin/equipment-report?id=${currentEquipmentId}&start=${startDate}&end=${endDate}`;
    closeReportModal();
}

window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
}
</script>
{{end}}
