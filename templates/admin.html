{{define "title"}}Admin Panel{{end}}

{{define "content"}}
<div class="admin-container">
    <h1>User Management</h1>

    {{with .Error}}
    <div class="alert alert-error">{{.}}</div>
    {{end}}
    
    {{with .Success}}
    <div class="alert alert-success">{{.}}</div>
    {{end}}

    <div class="users-table-wrapper">
        <table class="users-table">
            <thead>
                <tr>
                    <th>Username</th>
                    <!-- <th>Created</th> -->
                    <th>Status</th>
                    <th>Equipment Access</th>
                    <th>Admin Status</th>
                </tr>
            </thead>
            <tbody>
                {{range .Users}}
                <tr data-user-id="{{.UserID}}">
                    <td>{{.Username}}</td>
                    <!-- <td>{{.CreatedAt}}</td> -->
                    <td>
                        <label class="toggle">
                            <input type="checkbox" class="approved-toggle" 
                                   {{if .Approved}}checked{{end}}
                                   onchange="updateAccess({{.UserID}})">
                            Approved
                        </label>
                    </td>
                    <td>
                        <div class="equipment-access">
                            <select multiple class="equipment-select" 
                                    onchange="updateAccess({{.UserID}})">
                                {{$user := .}}
                                {{range $equipment := $.Equipment}}
                                <option value="{{$equipment.ID}}" 
                                        {{range $user.EquipmentAccess}}
                                            {{if eq .ID $equipment.ID}}selected{{end}}
                                        {{end}}>
                                        {{$equipment.Name}}
                                    </option>
                                {{end}}
                            </select>
                        </div>
                    </td>
                    <td>
                        <form action="/admin/set-admin" method="POST" class="inline-form">
                            <input type="hidden" name="user_id" value="{{.UserID}}">
                            {{if not .Admin}}
                                <button type="submit" name="is_admin" value="true" 
                                        class="btn btn-small">Make Admin</button>
                            {{else}}
                                <button type="submit" name="is_admin" value="false"
                                        class="btn btn-small btn-danger">Remove Admin</button>
                            {{end}}
                        </form>
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
</div>

<style>
.admin-container {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.users-table-wrapper {
    overflow-x: auto;
    margin-top: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.users-table {
    width: 100%;
    border-collapse: collapse;
}

.users-table th,
.users-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.users-table th {
    background: #f8f9fa;
    font-weight: 600;
}

.equipment-select {
    width: 100%;
    min-height: 100px;
    padding: 4px;
}

.toggle {
    display: flex;
    align-items: center;
    gap: 6px;
}

.btn-small {
    padding: 4px 8px;
    font-size: 0.875rem;
}

.btn-danger {
    background: #dc3545;
    color: white;
}
</style>

<script>
async function updateAccess(userId) {
    const row = document.querySelector(`tr[data-user-id="${userId}"]`);
    const approved = row.querySelector('.approved-toggle').checked;
    const equipmentSelect = row.querySelector('.equipment-select');
    const selectedEquipment = Array.from(equipmentSelect.selectedOptions)
                                  .map(option => parseInt(option.value));

    try {
        const response = await fetch('/admin/update-access', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: userId,
                approved: approved,
                equipment: selectedEquipment
            })
        });

        if (!response.ok) {
            throw new Error('Failed to update access');
        }

        // // Show success message
        // const msg = document.createElement('div');
        // msg.className = 'alert alert-success';
        // msg.textContent = 'Access updated successfully';
        // document.querySelector('.admin-container').insertBefore(
        //     msg, 
        //     document.querySelector('.users-table-wrapper')
        // );
        // setTimeout(() => msg.remove(), 3000);

    } catch (error) {
        console.error('Error:', error);
        alert('Failed to update access rights');
        location.reload();
    }
}
</script>
{{end}}