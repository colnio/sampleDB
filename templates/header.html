{{define "header"}}
<header class="site-header">
    <nav class="main-nav" aria-label="Primary navigation">
        <div class="nav-brand">
            <a href="/" class="nav-logo">Sample Tracker</a>
            <button class="nav-toggle" type="button" id="primary-nav-toggle" aria-expanded="false"
                aria-controls="primary-nav" aria-label="Toggle navigation">
                <span class="nav-toggle-label">Menu</span>
                <svg class="nav-toggle-icon" width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"
                    focusable="false">
                    <path fill="currentColor" d="M4 6h16a1 1 0 010 2H4a1 1 0 110-2zm0 5h16a1 1 0 010 2H4a1 1 0 110-2zm0 5h16a1 1 0 010 2H4a1 1 0 110-2z" />
                </svg>
            </button>
        </div>
        <div class="nav-drawer nav-drawer--open" id="primary-nav" aria-hidden="false">
            <div class="nav-links">
                <a href="/wiki" class="nav-item">
                    <svg class="nav-item__icon" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                        <rect x="4.5" y="5" width="8" height="14" rx="1.75" ry="1.75" fill="none" stroke="currentColor" stroke-width="1.5"></rect>
                        <path d="M12.5 5.75H17a1.75 1.75 0 011.75 1.75v11.75" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                        <path d="M7.25 9h3.25m-3.25 3h2.5" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
                    </svg>
                    <span>Wiki</span>
                </a>
                <a href="/samples/new" class="nav-item">
                    <svg class="nav-item__icon" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                        <path d="M12 5v14M5 12h14" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
                    </svg>
                    <span>New Sample</span>
                </a>
                <a href="/booking" class="nav-item">
                    <svg class="nav-item__icon" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                        <rect x="3.75" y="5.5" width="16.5" height="14.5" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="1.5"></rect>
                        <path d="M8 3.75v3.5m8-3.5v3.5M3.75 10.5h16.5" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
                        <circle cx="16" cy="15.5" r="1.6" fill="currentColor"></circle>
                    </svg>
                    <span>Equipment Booking</span>
                </a>
                {{if .IsAdmin}}
                <a href="/admin" class="nav-item">
                    <svg class="nav-item__icon" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                        <path d="M12 3l7 3v6c0 4.23-2.86 8.09-7 9-4.14-.91-7-4.77-7-9V6z" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"></path>
                        <path d="M12 11.5a2 2 0 100 4 2 2 0 000-4z" fill="currentColor"></path>
                    </svg>
                    <span>Admin Panel</span>
                </a>
                {{end}}
            </div>
            <div class="nav-actions">
                <button class="theme-toggle" type="button" id="theme-toggle" aria-pressed="false" aria-label="Toggle dark mode">
                    <svg class="theme-toggle__icon theme-toggle__icon--sun" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                        <path fill="currentColor" d="M12 5.5a1 1 0 011 1V9a1 1 0 11-2 0V6.5a1 1 0 011-1zm0 8.5a3 3 0 100-6 3 3 0 000 6zm6.5-3a1 1 0 011 1h2.5a1 1 0 110 2H19.5a1 1 0 01-1-1v-2zm-16 1a1 1 0 01-1 1H1a1 1 0 110-2h2.5a1 1 0 011 1zm13.4 5.4a1 1 0 011.4 0l1.8 1.8a1 1 0 11-1.4 1.4l-1.8-1.8a1 1 0 010-1.4zM7.7 6.3a1 1 0 01-1.4 0L4.5 4.5A1 1 0 115.9 3.1l1.8 1.8a1 1 0 010 1.4zm10.8-1.8a1 1 0 011.4 1.4l-1.8 1.8a1 1 0 01-1.4-1.4zM6.3 16.3a1 1 0 010 1.4L4.5 19.5A1 1 0 113.1 18.1l1.8-1.8a1 1 0 011.4 0zm4.7 3.2a1 1 0 011-1h2.5a1 1 0 110 2H12a1 1 0 01-1-1z"/>
                    </svg>
                    <svg class="theme-toggle__icon theme-toggle__icon--moon" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                        <path fill="currentColor" d="M21 14.5A8.5 8.5 0 1110.5 4a7 7 0 009.9 9.9c.25.18.5.37.6.6z"/>
                    </svg>
                    <span class="theme-toggle__label" id="theme-toggle-label">Dark mode</span>
                </button>
                <div class="user-menu">
                    <button class="user-menu-toggle" type="button" id="user-menu-toggle" aria-haspopup="true"
                        aria-expanded="false">
                        <span class="user-menu-label">{{if .Username}}{{.Username}}{{else}}Account{{end}}</span>
                        <svg width="14" height="14" viewBox="0 0 20 20" aria-hidden="true" focusable="false">
                            <path d="M5.23 7.21a.75.75 0 011.06.02L10 10.122l3.71-2.89a.75.75 0 11.92 1.18l-4.18 3.255a.75.75 0 01-.92 0L5.21 8.41a.75.75 0 01.02-1.2z" fill="currentColor"></path>
                        </svg>
                    </button>
                    <div class="user-menu-dropdown" id="user-menu-dropdown" role="menu">
                        <a href="/change-password" class="dropdown-item" role="menuitem">Change Password</a>
                        <a href="/logout"
                           class="dropdown-item"
                           role="menuitem"
                           hx-boost="false">Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>
</header>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const navToggle = document.getElementById('primary-nav-toggle');
    const navDrawer = document.getElementById('primary-nav');
    const userMenu = document.querySelector('.user-menu');
    const userToggle = document.getElementById('user-menu-toggle');
    const themeToggle = document.getElementById('theme-toggle');
    const themeToggleLabel = document.getElementById('theme-toggle-label');
    const prefersDark = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;

    function isDesktop() {
        return window.matchMedia('(min-width: 768px)').matches;
    }

    function setNavOpen(open) {
        if (!navToggle || !navDrawer) return;
        if (isDesktop()) {
            navDrawer.classList.add('nav-drawer--open');
            navDrawer.setAttribute('aria-hidden', 'false');
            navToggle.setAttribute('aria-expanded', 'false');
            return;
        }
        navDrawer.classList.toggle('nav-drawer--open', open);
        navDrawer.setAttribute('aria-hidden', open ? 'false' : 'true');
        navToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
    }

    function setUserMenuOpen(open) {
        if (!userMenu || !userToggle) return;
        userMenu.classList.toggle('open', open);
        userToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
    }

    if (navToggle && navDrawer) {
        navToggle.addEventListener('click', function (event) {
            event.stopPropagation();
            if (isDesktop()) {
                return;
            }
            const isExpanded = navToggle.getAttribute('aria-expanded') === 'true';
            setNavOpen(!isExpanded);
        });

        navDrawer.addEventListener('click', function (event) {
            if (isDesktop()) {
                return;
            }
            let target = event.target instanceof Element ? event.target : null;
            while (target && target !== navDrawer) {
                if (target.classList && target.classList.contains('nav-item')) {
                    setNavOpen(false);
                    break;
                }
                target = target.parentElement;
            }
        });

        navDrawer.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                setNavOpen(false);
                navToggle.focus();
            }
        });

        window.addEventListener('resize', function () {
            if (isDesktop()) {
                setNavOpen(false);
            } else if (navToggle.getAttribute('aria-expanded') === 'true') {
                setNavOpen(true);
            } else {
                setNavOpen(false);
            }
        });
    }

    if (userMenu && userToggle) {
        userToggle.addEventListener('click', function (event) {
            event.stopPropagation();
            const isExpanded = userToggle.getAttribute('aria-expanded') === 'true';
            setUserMenuOpen(!isExpanded);
        });
    }

    function getStoredTheme() {
        try {
            return localStorage.getItem('color-theme');
        } catch (err) {
            return null;
        }
    }

    function setStoredTheme(theme) {
        try {
            localStorage.setItem('color-theme', theme);
        } catch (err) {
            // Ignore write failures (e.g. private browsing)
        }
    }

    function updateThemeToggleLabel(theme) {
        if (!themeToggle) {
            return;
        }
        const isDark = theme === 'dark';
        themeToggle.setAttribute('aria-pressed', isDark ? 'true' : 'false');
        const nextMode = isDark ? 'Dark mode' : 'Light mode';
        themeToggle.setAttribute('aria-label', `Switch to ${nextMode.toLowerCase()}`);
        if (themeToggleLabel) {
            themeToggleLabel.textContent = nextMode;
        }
    }

    function applyTheme(theme, persist = true) {
        const safeTheme = theme === 'dark' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', safeTheme);
        document.documentElement.style.colorScheme = safeTheme === 'dark' ? 'dark' : 'light';
        if (persist) {
            setStoredTheme(safeTheme);
        }
        updateThemeToggleLabel(safeTheme);
    }

    document.addEventListener('click', function (event) {
        if (navToggle && navDrawer) {
            const isExpanded = navToggle.getAttribute('aria-expanded') === 'true';
            if (!isDesktop() && isExpanded && !navDrawer.contains(event.target) && !navToggle.contains(event.target)) {
                setNavOpen(false);
            }
        }

        if (userMenu && userToggle) {
            if (!userMenu.contains(event.target)) {
                setUserMenuOpen(false);
            }
        }
    });

    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            if (navToggle && navToggle.getAttribute('aria-expanded') === 'true') {
                setNavOpen(false);
                navToggle.focus();
            }

            if (userToggle && userToggle.getAttribute('aria-expanded') === 'true') {
                setUserMenuOpen(false);
                userToggle.focus();
            }
        }
    });
    if (themeToggle) {
        updateThemeToggleLabel(document.documentElement.getAttribute('data-theme') || 'light');
        const storedTheme = getStoredTheme();
        if (storedTheme) {
            applyTheme(storedTheme, false);
        }
        themeToggle.addEventListener('click', function () {
            const currentTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
            const nextTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(nextTheme);
        });
    }

    if (prefersDark && typeof prefersDark.addEventListener === 'function') {
        prefersDark.addEventListener('change', function (event) {
            if (!getStoredTheme()) {
                applyTheme(event.matches ? 'dark' : 'light', false);
            }
        });
    } else if (prefersDark && typeof prefersDark.addListener === 'function') {
        prefersDark.addListener(function (event) {
            if (!getStoredTheme()) {
                applyTheme(event.matches ? 'dark' : 'light', false);
            }
        });
    }

    setNavOpen(false);
});
</script>
{{end}}
