{{define "header"}}
<header class="site-header">
    <nav class="main-nav" aria-label="Primary navigation">
        <div class="nav-brand">
            <a href="/" class="nav-logo">Sample Tracker</a>
            <button class="nav-toggle" type="button" id="primary-nav-toggle" aria-expanded="false"
                aria-controls="primary-nav" aria-label="Toggle navigation">
                <span class="nav-toggle-label">Menu</span>
                <svg class="nav-toggle-icon" width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"
                    focusable="false">
                    <path fill="currentColor" d="M4 6h16a1 1 0 010 2H4a1 1 0 110-2zm0 5h16a1 1 0 010 2H4a1 1 0 110-2zm0 5h16a1 1 0 010 2H4a1 1 0 110-2z" />
                </svg>
            </button>
        </div>
        <div class="nav-drawer nav-drawer--open" id="primary-nav" aria-hidden="false">
            <div class="nav-links">
                <a href="/wiki" class="nav-item">
                    <svg class="nav-item__icon" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                        <rect x="4.5" y="5" width="8" height="14" rx="1.75" ry="1.75" fill="none" stroke="currentColor" stroke-width="1.5"></rect>
                        <path d="M12.5 5.75H17a1.75 1.75 0 011.75 1.75v11.75" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                        <path d="M7.25 9h3.25m-3.25 3h2.5" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
                    </svg>
                    <span>Wiki</span>
                </a>
                <a href="/booking" class="nav-item">
                    <svg class="nav-item__icon" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                        <rect x="3.75" y="5.5" width="16.5" height="14.5" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="1.5"></rect>
                        <path d="M8 3.75v3.5m8-3.5v3.5M3.75 10.5h16.5" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
                        <circle cx="16" cy="15.5" r="1.6" fill="currentColor"></circle>
                    </svg>
                    <span>Equipment Booking</span>
                </a>
                {{if .IsAdmin}}
                <a href="/admin" class="nav-item">
                    <svg class="nav-item__icon" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                        <path d="M12 3l7 3v6c0 4.23-2.86 8.09-7 9-4.14-.91-7-4.77-7-9V6z" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"></path>
                        <path d="M12 11.5a2 2 0 100 4 2 2 0 000-4z" fill="currentColor"></path>
                    </svg>
                    <span>Admin Panel</span>
                </a>
                {{end}}
            </div>
            <div class="nav-actions">
                <div class="user-menu">
                    <button class="user-menu-toggle" type="button" id="user-menu-toggle" aria-haspopup="true"
                        aria-expanded="false">
                        <span class="user-menu-label">{{if .Username}}{{.Username}}{{else}}Account{{end}}</span>
                        <svg width="14" height="14" viewBox="0 0 20 20" aria-hidden="true" focusable="false">
                            <path d="M5.23 7.21a.75.75 0 011.06.02L10 10.122l3.71-2.89a.75.75 0 11.92 1.18l-4.18 3.255a.75.75 0 01-.92 0L5.21 8.41a.75.75 0 01.02-1.2z" fill="currentColor"></path>
                        </svg>
                    </button>
                    <div class="user-menu-dropdown" id="user-menu-dropdown" role="menu">
                        <a href="/change-password" class="dropdown-item" role="menuitem">Change Password</a>
                        <a href="/logout"
                           class="dropdown-item"
                           role="menuitem"
                           hx-boost="false">Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>
</header>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const navToggle = document.getElementById('primary-nav-toggle');
    const navDrawer = document.getElementById('primary-nav');
    const userMenu = document.querySelector('.user-menu');
    const userToggle = document.getElementById('user-menu-toggle');

    function isDesktop() {
        return window.matchMedia('(min-width: 768px)').matches;
    }

    function setNavOpen(open) {
        if (!navToggle || !navDrawer) return;
        if (isDesktop()) {
            navDrawer.classList.add('nav-drawer--open');
            navDrawer.setAttribute('aria-hidden', 'false');
            navToggle.setAttribute('aria-expanded', 'false');
            return;
        }
        navDrawer.classList.toggle('nav-drawer--open', open);
        navDrawer.setAttribute('aria-hidden', open ? 'false' : 'true');
        navToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
    }

    function setUserMenuOpen(open) {
        if (!userMenu || !userToggle) return;
        userMenu.classList.toggle('open', open);
        userToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
    }

    if (navToggle && navDrawer) {
        navToggle.addEventListener('click', function (event) {
            event.stopPropagation();
            if (isDesktop()) {
                return;
            }
            const isExpanded = navToggle.getAttribute('aria-expanded') === 'true';
            setNavOpen(!isExpanded);
        });

        navDrawer.addEventListener('click', function (event) {
            if (isDesktop()) {
                return;
            }
            let target = event.target instanceof Element ? event.target : null;
            while (target && target !== navDrawer) {
                if (target.classList && target.classList.contains('nav-item')) {
                    setNavOpen(false);
                    break;
                }
                target = target.parentElement;
            }
        });

        navDrawer.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                setNavOpen(false);
                navToggle.focus();
            }
        });

        window.addEventListener('resize', function () {
            if (isDesktop()) {
                setNavOpen(false);
            } else if (navToggle.getAttribute('aria-expanded') === 'true') {
                setNavOpen(true);
            } else {
                setNavOpen(false);
            }
        });
    }

    if (userMenu && userToggle) {
        userToggle.addEventListener('click', function (event) {
            event.stopPropagation();
            const isExpanded = userToggle.getAttribute('aria-expanded') === 'true';
            setUserMenuOpen(!isExpanded);
        });
    }

    document.addEventListener('click', function (event) {
        if (navToggle && navDrawer) {
            const isExpanded = navToggle.getAttribute('aria-expanded') === 'true';
            if (!isDesktop() && isExpanded && !navDrawer.contains(event.target) && !navToggle.contains(event.target)) {
                setNavOpen(false);
            }
        }

        if (userMenu && userToggle) {
            if (!userMenu.contains(event.target)) {
                setUserMenuOpen(false);
            }
        }
    });

    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            if (navToggle && navToggle.getAttribute('aria-expanded') === 'true') {
                setNavOpen(false);
                navToggle.focus();
            }

            if (userToggle && userToggle.getAttribute('aria-expanded') === 'true') {
                setUserMenuOpen(false);
                userToggle.focus();
            }
        }
    });
    setNavOpen(false);
});
</script>
{{end}}
