{{define "title"}}Equipment Booking{{end}}

{{define "content"}}
<div class="booking-page">
    <header class="page-heading">
        <h1 class="heading-with-icon">
            <svg class="heading-with-icon__icon" width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                <rect x="3.75" y="5.5" width="16.5" height="14.5" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="1.5"></rect>
                <path d="M8 3.75v3.5m8-3.5v3.5M3.75 10.5h16.5" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>
                <path d="M15.75 14.5h2.5v2.5" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                <circle cx="16" cy="15.5" r="1.6" fill="currentColor"></circle>
            </svg>
            <span>Equipment Booking</span>
        </h1>
    </header>

    <div class="booking-toolbar">
        <div class="toolbar-section">
            <a href="/booking?date={{formatDateISO (addDays .SelectedDate -1)}}" class="nav-chip">&laquo; Prev Day</a>
        </div>
        <div class="toolbar-section toolbar-section--search">
            <span class="toolbar-label">Search</span>
            <form class="toolbar-search" action="/booking" method="GET" autocomplete="off">
                <input type="date" name="date" value="{{formatDateISO .SelectedDate}}" aria-label="Select date" autocomplete="off">
                <button class="button button--primary" type="submit">Find</button>
            </form>
        </div>
        <div class="toolbar-section">
            <a href="/booking?date={{formatDateISO (addDays .SelectedDate 1)}}" class="nav-chip">Next Day &raquo;</a>
        </div>
    </div>

    {{with .Error}}
    <div class="alert alert-error">{{.}}</div>
    {{end}}

    {{with .Success}}
    <div class="alert alert-success">{{.}}</div>
    {{end}}

    <div class="day-banner">
        <div class="day-banner__day">{{formatDayName .SelectedDate}}</div>
        <div class="day-banner__date">{{formatDateNumeric .SelectedDate}}</div>
    </div>

    <div class="timeline-shell">
        <div class="timeline-header">
            <div class="timeline-equipment-col">Equipment</div>
            <div class="timeline-hours">
                {{range .Hours}}
                <div class="timeline-hour"><span>{{formatTime .}}</span></div>
                {{end}}
            </div>
        </div>
        <div class="timeline-body">
            {{range .Equipment}}
            {{$equipment := .}}
            <div class="timeline-row">
                <div class="timeline-equipment">
                    <div class="equipment-title">{{$equipment.Name}}</div>
                    <!-- <div class="equipment-meta">
                        <a class="equipment-link" href="#" aria-disabled="true">Rules</a>
                    </div> -->
                </div>
                {{if index $.HasPermission $equipment.ID}}
                <div class="timeline-lane" data-equipment="{{$equipment.ID}}">
                    <div class="lane-grid">
                        {{range $.TimeSlots}}
                        <div class="lane-cell"
                             data-equipment="{{$equipment.ID}}"
                             data-datetime="{{formatDateTimeISO (combineDatetime $.SelectedDate .)}}"
                             onclick="handleLaneCellClick(this)"></div>
                        {{end}}
                    </div>
                </div>
                {{else}}
                <div class="timeline-lane timeline-lane--locked">
                    <span>No access</span>
                </div>
                {{end}}
            </div>
            {{end}}
        </div>
    </div>

    <div id="booking-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>New Booking</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="booking-form" action="/booking" method="POST" class="stacked-form" autocomplete="off">
                <input type="hidden" name="equipment_id" id="equipment_id" autocomplete="off">
                <div class="form-group">
                    <label for="start_time">Start Time:</label>
                    <input type="datetime-local" id="start_time" name="start_time" required autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="end_time">End Time:</label>
                    <input type="datetime-local" id="end_time" name="end_time" required autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="purpose">Purpose:</label>
                    <textarea id="purpose" name="purpose" required autocomplete="off"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="button button--primary">Book</button>
                    <button type="button" class="button button--secondary" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.booking-page {
    --equipment-col-width: 240px;
    --hour-width: 88px;
    --slots-per-hour: 4;
    --slot-width: calc(var(--hour-width) / var(--slots-per-hour));
    --total-slots: 96;
    --lane-width: calc(var(--slot-width) * var(--total-slots));
    --lane-height: 72px;
    --grid-border: #cbd5e1;
    padding: var(--space-md);
    max-width: 1800px;
    margin: 0 auto;
}

.booking-toolbar {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    flex-wrap: wrap;
    padding: 12px 16px;
    background: var(--surface-default);
    border: 1px solid var(--border-subtle);
    border-radius: 12px;
    box-shadow: var(--card-shadow);
}

.toolbar-section {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.toolbar-section--search {
    flex: 1;
}

.toolbar-label {
    font-weight: 700;
    color: var(--text-strong);
}

.toolbar-search {
    display: flex;
    gap: var(--space-sm);
    align-items: center;
}

.toolbar-search input[type="date"] {
    border: 1px solid var(--grid-border);
    border-radius: 10px;
    padding: 10px 12px;
    font-weight: 600;
    font-size: 0.95rem;
}

.toolbar-section--actions {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.nav-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 14px;
    border-radius: 10px;
    border: 1px solid var(--grid-border);
    background: #f8fafc;
    color: var(--neutral-800);
    font-weight: 700;
    text-decoration: none;
    transition: all 0.2s ease;
}

.nav-chip:hover {
    background: #e2e8f0;
    border-color: #94a3b8;
}

.button--positive {
    background: #22a565;
    border-color: #1f9a5e;
    color: #ffffff;
    box-shadow: 0 4px 12px rgba(34, 165, 101, 0.22);
}

.button--positive:hover {
    background: #1b8b55;
}

.day-banner {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin: 16px 0 8px;
    font-weight: 700;
    color: #0f172a;
}

.day-banner__day {
    padding: 8px 12px;
    border-radius: 12px;
    background: #1f3b57;
    color: #ffffff;
    letter-spacing: 0.04em;
    text-transform: uppercase;
}

.day-banner__date {
    font-size: 1.05rem;
}

.timeline-shell {
    overflow-x: auto;
    border: 1px solid var(--grid-border);
    border-radius: 12px;
    background: var(--surface-default);
    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
}

.timeline-header {
    display: flex;
    min-width: calc(var(--equipment-col-width) + var(--lane-width));
    position: sticky;
    top: 0;
    z-index: 5;
}

.timeline-equipment-col {
    width: var(--equipment-col-width);
    min-width: var(--equipment-col-width);
    background: #1f3b57;
    color: #ffffff;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 12px;
    border-right: 1px solid rgba(255, 255, 255, 0.12);
}

.timeline-hours {
    display: grid;
    grid-template-columns: repeat(24, var(--hour-width));
    min-width: calc(var(--hour-width) * 24);
    width: var(--lane-width);
    flex: 0 0 var(--lane-width);
    background: #f2f6fb;
    border-left: 1px solid var(--grid-border);
}

.timeline-hour {
    border-right: 1px solid var(--grid-border);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px 4px;
    font-weight: 700;
    color: #0f172a;
    font-size: 0.95rem;
}
.timeline-hour:first-child {
    border-left: 1px solid var(--grid-border);
}
.timeline-hour:last-child {
    border-right: 1px solid var(--grid-border);
}

.timeline-body {
    display: flex;
    flex-direction: column;
    min-width: calc(var(--equipment-col-width) + var(--lane-width));
}

.timeline-row {
    display: flex;
    min-width: calc(var(--equipment-col-width) + var(--lane-width));
}

.timeline-equipment {
    width: var(--equipment-col-width);
    min-width: var(--equipment-col-width);
    background: #e5edf7;
    border-right: 1px solid var(--grid-border);
    border-bottom: 1px solid var(--grid-border);
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.equipment-title {
    font-weight: 700;
    color: #0f172a;
}

.equipment-link {
    color: #1f7cd6;
    font-weight: 600;
    text-decoration: none;
    font-size: 0.9rem;
}

.timeline-lane {
    position: relative;
    width: var(--lane-width);
    min-width: var(--lane-width);
    height: var(--lane-height);
    border-bottom: 1px solid var(--grid-border);
    border-left: 1px solid var(--grid-border);
    overflow: hidden;
    flex: 0 0 var(--lane-width);
}

.timeline-lane:not(.timeline-lane--locked) {
    background: linear-gradient(to right, #eef2f7 0%, #f5f7fb 100%);
}

.timeline-lane--locked {
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    background: repeating-linear-gradient(-45deg, #f8fafc 0, #f8fafc 12px, #e2e8f0 12px, #e2e8f0 24px);
    border-left: 1px solid var(--grid-border);
}

.lane-grid {
    position: absolute;
    inset: 0;
    display: grid;
    grid-template-columns: repeat(96, var(--slot-width));
    grid-auto-rows: 1fr;
    background: repeating-linear-gradient(
            to right,
            #d7dee6 0,
            #d7dee6 1px,
            transparent 1px,
            transparent calc(var(--hour-width))
        );
}

.lane-cell {
    height: 100%;
    border-right: 1px solid rgba(15, 23, 42, 0.08);
}

.lane-cell:hover {
    background: rgba(37, 99, 235, 0.12);
    cursor: pointer;
    transition: background 0.15s ease;
}

@media (min-width: 769px) {
    .timeline-equipment-col,
    .timeline-equipment {
        position: sticky;
        left: 0;
    }

    .timeline-equipment-col {
        z-index: 7;
        box-shadow: 6px 0 12px rgba(15, 23, 42, 0.08);
    }

    .timeline-equipment {
        z-index: 6;
        box-shadow: 4px 0 10px rgba(15, 23, 42, 0.06);
    }
}

.booking-block {
    position: absolute;
    top: 10px;
    height: calc(var(--lane-height) - 20px);
    border-radius: 6px;
    background: #1f7cd6;
    color: #ffffff;
    font-weight: 700;
    letter-spacing: 0.02em;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 12px;
    box-shadow: 0 6px 14px rgba(15, 23, 42, 0.25);
    text-transform: uppercase;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    z-index: 2;
}

.booking-block--own {
    background: #d92525;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
}

.modal-content {
    position: relative;
    background-color: var(--surface-default);
    margin: 8% auto;
    padding: 20px;
    width: 90%;
    max-width: 520px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--neutral-200);
}

.modal-header h3 {
    margin: 0;
}

.close {
    font-size: 24px;
    font-weight: bold;
    color: var(--neutral-600);
    cursor: pointer;
}

.close:hover {
    color: var(--neutral-900);
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: calc(var(--space-sm) - 0.1rem);
    margin-bottom: var(--space-md);
}

.form-group textarea {
    min-height: 140px;
    resize: vertical;
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: var(--space-md);
    flex-wrap: wrap;
    margin-top: var(--space-md);
}

@media (max-width: 1200px) {
    .booking-page {
        --hour-width: 72px;
    }

    .booking-toolbar {
        flex-direction: column;
        align-items: flex-start;
    }

    .toolbar-section--actions {
        width: 100%;
        justify-content: flex-start;
    }
}

@media (max-width: 768px) {
    .booking-page {
        --hour-width: 56px;
        --lane-height: 64px;
        --equipment-col-width: 180px;
        padding: var(--space-sm);
    }

    .booking-toolbar {
        flex-direction: column;
        align-items: stretch;
        gap: var(--space-sm);
    }

    .toolbar-section {
        width: 100%;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: var(--space-xs);
    }

    .toolbar-section--search {
        flex-direction: column;
        align-items: stretch;
        gap: var(--space-xs);
    }

    .toolbar-search {
        width: 100%;
        flex-wrap: wrap;
        gap: var(--space-xs);
    }

    .toolbar-search input[type="date"] {
        width: 100%;
    }

    .toolbar-search .button,
    .nav-chip {
        width: 100%;
        justify-content: center;
    }

    .day-banner {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }

    .timeline-hour {
        font-size: 0.85rem;
        padding: 8px 2px;
    }
}
</style>

<script>
    var bookings = {{toJSON .Bookings}};
    var currentUserId = {{.BasePageData.UserID}};
    var selectedDateStr = '{{formatDateISO .SelectedDate}}';
    var dayStart = new Date(selectedDateStr + 'T00:00:00');
    var dayEnd = new Date(dayStart.getTime() + 24 * 60 * 60 * 1000);

    function formatLocalInputValue(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    function formatDisplayTime(date) {
        return date.toLocaleTimeString([], {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });
    }

    function formatTimeRange(start, end) {
        return `${formatDisplayTime(start)} - ${formatDisplayTime(end)}`;
    }

    function handleLaneCellClick(element) {
        if (element.classList.contains('booked')) {
            return;
        }

        const equipmentId = element.dataset.equipment;
        const startDate = new Date(element.dataset.datetime);
        const endDate = new Date(startDate.getTime() + 60 * 60 * 1000);
        openModalWithValues(equipmentId, startDate, endDate);
    }

    function openQuickBooking() {
        const firstLane = document.querySelector('.timeline-lane[data-equipment]');
        if (!firstLane) {
            return;
        }

        const startDate = new Date(dayStart.getTime());
        startDate.setHours(9, 0, 0, 0);
        const endDate = new Date(startDate.getTime() + 60 * 60 * 1000);
        openModalWithValues(firstLane.dataset.equipment, startDate, endDate);
    }

    function openModalWithValues(equipmentId, startDate, endDate) {
        const modal = document.getElementById('booking-modal');
        const equipmentInput = document.getElementById('equipment_id');
        const startInput = document.getElementById('start_time');
        const endInput = document.getElementById('end_time');

        if (!modal || !equipmentInput || !startInput || !endInput) {
            return;
        }

        equipmentInput.value = equipmentId;
        startInput.value = formatLocalInputValue(startDate);
        endInput.value = formatLocalInputValue(endDate);
        modal.style.display = 'block';
    }

    function confirmDeleteBooking(bookingId) {
        if (confirm('Are you sure you want to delete this booking?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/booking/delete';

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'booking_id';
            input.value = bookingId;

            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }
    }

    function closeModal() {
        const modal = document.getElementById('booking-modal');
        if (modal) {
            modal.style.display = 'none';
            const form = document.getElementById('booking-form');
            if (form) {
                form.reset();
            }
        }
    }

    window.onclick = function(event) {
        const modal = document.getElementById('booking-modal');
        if (event.target === modal) {
            closeModal();
        }
    }

    function renderBookings() {
        if (!bookings || !bookings.length) {
            return;
        }

        const adjustBlockFontSize = (block, widthPercent, lane) => {
            const laneWidth = lane.getBoundingClientRect().width || 0;
            const blockWidthPx = (widthPercent / 100) * laneWidth;
            let size = 14;
            if (blockWidthPx < 80) size = 12;
            if (blockWidthPx < 60) size = 10;
            if (blockWidthPx < 46) size = 9;
            block.style.fontSize = `${size}px`;
        };

        const minutesInDay = 24 * 60;

        document.querySelectorAll('.timeline-lane').forEach(lane => {
            if (!lane.dataset.equipment) {
                return;
            }

            lane.querySelectorAll('.booking-block').forEach(el => el.remove());

            const equipmentId = Number(lane.dataset.equipment);
            const equipmentBookings = bookings.filter(b => b.equipment_id === equipmentId);

            equipmentBookings.forEach(booking => {
                const bookingStart = new Date(booking.start_time);
                const bookingEnd = new Date(booking.end_time);

                if (bookingEnd <= dayStart || bookingStart >= dayEnd) {
                    return;
                }

                const startMs = Math.max(bookingStart.getTime(), dayStart.getTime());
                const endMs = Math.min(bookingEnd.getTime(), dayEnd.getTime());

                if (endMs <= startMs) {
                    return;
                }

                const start = new Date(startMs);
                const end = new Date(endMs);
                // Use offsets from the start of the selected day to handle bookings that cross midnight
                const startOffsetMinutes = (start.getTime() - dayStart.getTime()) / (60 * 1000);
                const endOffsetMinutes = (end.getTime() - dayStart.getTime()) / (60 * 1000);
                const duration = Math.max(endOffsetMinutes - startOffsetMinutes, 10);

                const left = (startOffsetMinutes / minutesInDay) * 100;
                let width = (duration / minutesInDay) * 100;
                if (left + width > 100) {
                    width = 100 - left;
                }
                width = Math.max(width, 1.5);

                const block = document.createElement('div');
                block.className = 'booking-block' + (booking.user_id === currentUserId ? ' booking-block--own' : '');
                block.style.left = `${left}%`;
                block.style.width = `${width}%`;
                block.title = `${booking.username} â€¢ ${formatTimeRange(bookingStart, bookingEnd)}\n${booking.purpose}`;
                block.textContent = booking.username.toUpperCase();

                adjustBlockFontSize(block, width, lane);

                if (booking.user_id === currentUserId) {
                    block.onclick = () => confirmDeleteBooking(booking.id);
                }

                lane.appendChild(block);
            });
        });
    }

    function bindFormValidation() {
        const form = document.getElementById('booking-form');
        if (!form || form.dataset.bound === 'true') {
            return;
        }

        form.addEventListener('submit', function(e) {
            const startTime = new Date(document.getElementById('start_time').value);
            const endTime = new Date(document.getElementById('end_time').value);
            const purpose = document.getElementById('purpose').value;

            if (endTime <= startTime) {
                e.preventDefault();
                alert('End time must be after start time');
                return;
            }

            if (!purpose.trim()) {
                e.preventDefault();
                alert('Purpose is required');
                return;
            }
        });

        form.dataset.bound = 'true';
    }

    function initializeBookingPage() {
        renderBookings();
        bindFormValidation();
    }

    initializeBookingPage();

    if (window.htmx) {
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            if (evt.detail && evt.detail.target && evt.detail.target.id === 'page-root') {
                initializeBookingPage();
            }
        });
    }
</script>
{{end}}
